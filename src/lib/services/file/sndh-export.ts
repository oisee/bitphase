import type { Project } from '../../models/project';
import { downloadFile, sanitizeFilename } from '../../utils/file-download';
import { generatePSGBuffer } from './psg-export';

const SNDH_HEADER = new Uint8Array([
	0x60, 0x00, 0x00, 0x38, 0x60, 0x00, 0x00, 0x4a, 0x60, 0x00, 0x00, 0x5a, 0x53, 0x4e, 0x44, 0x48,
	0x54, 0x49, 0x54, 0x4c, 0x00, 0x43, 0x4f, 0x4d, 0x4d, 0x00, 0x52, 0x49, 0x50, 0x50, 0x00, 0x43,
	0x4f, 0x4e, 0x56, 0x00, 0x23, 0x23, 0x30, 0x31, 0x00, 0x54, 0x43, 0x35, 0x30, 0x00, 0x59, 0x45,
	0x41, 0x52, 0x00, 0x00, 0x00, 0x50, 0x48, 0x44, 0x4e, 0x53, 0x48, 0xe7, 0xff, 0xfe, 0x41, 0xfa,
	0x01, 0x12, 0x58, 0x88, 0x43, 0xfa, 0x00, 0x1a, 0x22, 0x88, 0x4c, 0xdf, 0x7f, 0xff, 0x4e, 0x75,
	0x4e, 0x75, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x48, 0xe7, 0xff, 0xfe, 0x4d, 0xfa, 0xff, 0xe8, 0x43, 0xfa, 0xff, 0xf2,
	0x20, 0x51, 0x70, 0x00, 0x1d, 0x7c, 0x00, 0xff, 0x00, 0x0d, 0x10, 0x18, 0x6d, 0x6c, 0x1d, 0x98,
	0x00, 0x00, 0x10, 0x18, 0x6d, 0x64, 0x1d, 0x98, 0x00, 0x00, 0x10, 0x18, 0x6d, 0x5c, 0x1d, 0x98,
	0x00, 0x00, 0x10, 0x18, 0x6d, 0x54, 0x1d, 0x98, 0x00, 0x00, 0x10, 0x18, 0x6d, 0x4c, 0x1d, 0x98,
	0x00, 0x00, 0x10, 0x18, 0x6d, 0x44, 0x1d, 0x98, 0x00, 0x00, 0x10, 0x18, 0x6d, 0x3c, 0x1d, 0x98,
	0x00, 0x00, 0x10, 0x18, 0x6d, 0x34, 0x1d, 0x98, 0x00, 0x00, 0x10, 0x18, 0x6d, 0x2c, 0x1d, 0x98,
	0x00, 0x00, 0x10, 0x18, 0x6d, 0x24, 0x1d, 0x98, 0x00, 0x00, 0x10, 0x18, 0x6d, 0x1c, 0x1d, 0x98,
	0x00, 0x00, 0x10, 0x18, 0x6d, 0x14, 0x1d, 0x98, 0x00, 0x00, 0x10, 0x18, 0x6d, 0x0c, 0x1d, 0x98,
	0x00, 0x00, 0x10, 0x18, 0x6d, 0x04, 0x1d, 0x98, 0x00, 0x00, 0x22, 0x88, 0x47, 0xf8, 0x88, 0x00,
	0x43, 0xf8, 0x88, 0x02, 0x16, 0xbc, 0x00, 0x00, 0x12, 0x9e, 0x16, 0xbc, 0x00, 0x01, 0x12, 0x9e,
	0x16, 0xbc, 0x00, 0x02, 0x12, 0x9e, 0x16, 0xbc, 0x00, 0x03, 0x12, 0x9e, 0x16, 0xbc, 0x00, 0x04,
	0x12, 0x9e, 0x16, 0xbc, 0x00, 0x05, 0x12, 0x9e, 0x16, 0xbc, 0x00, 0x06, 0x12, 0x9e, 0x16, 0xbc,
	0x00, 0x07, 0x12, 0x9e, 0x16, 0xbc, 0x00, 0x08, 0x12, 0x9e, 0x16, 0xbc, 0x00, 0x09, 0x12, 0x9e,
	0x16, 0xbc, 0x00, 0x0a, 0x12, 0x9e, 0x16, 0xbc, 0x00, 0x0b, 0x12, 0x9e, 0x16, 0xbc, 0x00, 0x0c,
	0x12, 0x9e, 0x10, 0x1e, 0x6d, 0x06, 0x16, 0xbc, 0x00, 0x0d, 0x12, 0x80, 0x4c, 0xdf, 0x7f, 0xff,
	0x4e, 0x75
]);

function wrapPsgWithSndhHeader(psgBuffer: ArrayBuffer): ArrayBuffer {
	const psgData = new Uint8Array(psgBuffer);
	const sndhFile = new Uint8Array(SNDH_HEADER.length + psgData.length);
	sndhFile.set(SNDH_HEADER, 0);
	sndhFile.set(psgData, SNDH_HEADER.length);
	return sndhFile.buffer;
}

export async function exportToSNDH(
	project: Project,
	songIndex: number = 0,
	onProgress?: (progress: number, message: string) => void,
	abortSignal?: AbortSignal
): Promise<void> {
	onProgress?.(0, 'Preparing SNDH export...');

	if (abortSignal?.aborted) {
		throw new Error('Export cancelled');
	}

	onProgress?.(5, 'Generating PSG data...');
	const psgBuffer = await generatePSGBuffer(project, songIndex);

	if (abortSignal?.aborted) {
		throw new Error('Export cancelled');
	}

	onProgress?.(90, 'Wrapping with SNDH header...');
	const sndhBuffer = wrapPsgWithSndhHeader(psgBuffer);

	onProgress?.(95, 'Encoding SNDH file...');
	const blob = new Blob([sndhBuffer], { type: 'application/octet-stream' });

	if (abortSignal?.aborted) {
		throw new Error('Export cancelled');
	}

	onProgress?.(99, 'Downloading...');
	const filename = project.name || 'export';
	const sanitizedFilename = sanitizeFilename(filename);
	downloadFile(blob, `${sanitizedFilename}.sndh`);

	onProgress?.(100, 'Complete!');
}
